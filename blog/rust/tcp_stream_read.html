<!DOCTYPE html><html><head><link rel="shortcut icon" href="https://www.nextjs.cn/static/favicon/favicon.ico"/><script>var _hmt = _hmt || [];(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?50c47ad58047f480726591cca679297b";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, minimal-ui"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="black"/><meta name="format-detection" content="telephone=no, email=no"/><title>Read Rust TcpStream (ShineShao)</title><meta name="description" content="Rust原生读取TcpStream并转成字符串"/><meta name="keywords" content="ShineShao freeshineit Next.js Blog "/><meta name="next-head-count" content="8"/><link rel="preload" href="/_next/static/css/ea62958e264ac68e7a09.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ea62958e264ac68e7a09.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="/_next/static/chunks/webpack-10105bb2d855dad6dba6.js" defer=""></script><script src="/_next/static/chunks/framework-895f067827ebe11ffe45.js" defer=""></script><script src="/_next/static/chunks/main-c5c678ba45d45bf9d8f5.js" defer=""></script><script src="/_next/static/chunks/pages/_app-d5bae952006ea427deeb.js" defer=""></script><script src="/_next/static/chunks/pages/blog/rust/tcp_stream_read-2b2ab44a42c3f781bc35.js" defer=""></script><script src="/_next/static/lNSYQ5l6Gj-E0aCpr1D3s/_buildManifest.js" defer=""></script><script src="/_next/static/lNSYQ5l6Gj-E0aCpr1D3s/_ssgManifest.js" defer=""></script></head><body class="custom_class"><div id="__next"><div class="Layout_layout__3guix main-mdx" style="width:100%"><header class="Layout_header__1Ex29"><div class="Layout_container__2QLYW"><nav><ul><li><a href="/">Home</a></li><li><a href="/blog">Blog</a></li><li><a href="/readme">README</a></li></ul></nav><div class="Layout_right__2NMHu"><div class="Layout_Theme__3HBe3">🌜</div><a href="https://github.com/freeshineit" target="_block"><img src="/static/images/ShineShao.jpg" alt="ShineShao" class="ShineShao_ShineShao__3y7j0" style="width:34px;height:34px;border-radius:50%"/></a></div></div></header><div class="Layout_main__3m1yK" style="margin:0 auto"><div class="mdx-box"><article><h2 id="code" class="Heading_H2__2MwMw h2-tag"><a aria-hidden="true" tabindex="-1" href="#code" class="A_A__LqrNw a-tag"><span class="icon icon-link"></span></a>Code</h2><div class="Pre_Pre__269fU pre-tag"><pre class="Code_pre__r85Dc pre-tag prism-code language-rust " style="background-color:#2a2734;color:#9a86fd;overflow:scroll;margin-top:20px;margin-bottom:20px;padding:16px"><span class="Code_language__1zO4b">rust</span><div class="token-line"><span class="token plain" style="display:inline-block">use std::{</span></div><div class="token-line"><span class="token plain" style="display:inline-block">    io::{Read, Write},</span></div><div class="token-line"><span class="token plain" style="display:inline-block">    net::{TcpListener, TcpStream},</span></div><div class="token-line"><span class="token plain" style="display:inline-block">};</span></div><div class="token-line"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line"><span class="token plain" style="display:inline-block">use std::thread;</span></div><div class="token-line"><span class="token plain" style="display:inline-block">fn main() {</span></div><div class="token-line"><span class="token plain" style="display:inline-block">    let socket = TcpListener::bind(&quot;127.0.0.1:8080&quot;).unwrap();</span></div><div class="token-line"><span class="token plain" style="display:inline-block">    for stream in socket.incoming() {</span></div><div class="token-line"><span class="token plain" style="display:inline-block">        match stream {</span></div><div class="token-line"><span class="token plain" style="display:inline-block">            Err(e) =&gt; {</span></div><div class="token-line"><span class="token plain" style="display:inline-block">                eprintln!(&quot;error: {}&quot;, e)</span></div><div class="token-line"><span class="token plain" style="display:inline-block">            }</span></div><div class="token-line"><span class="token plain" style="display:inline-block">            Ok(stream) =&gt; {</span></div><div class="token-line"><span class="token plain" style="display:inline-block">                thread::spawn(move || {</span></div><div class="token-line"><span class="token plain" style="display:inline-block">                    handler(stream).unwrap_or_else(|error| eprintln!(&quot;{:?}&quot;, error));</span></div><div class="token-line"><span class="token plain" style="display:inline-block">                });</span></div><div class="token-line"><span class="token plain" style="display:inline-block">            }</span></div><div class="token-line"><span class="token plain" style="display:inline-block">        }</span></div><div class="token-line"><span class="token plain" style="display:inline-block">    }</span></div><div class="token-line"><span class="token plain" style="display:inline-block">}</span></div><div class="token-line"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line"><span class="token plain" style="display:inline-block">// Starts with being connected from a client</span></div><div class="token-line"><span class="token plain" style="display:inline-block">fn handler(mut stream: TcpStream) -&gt; Result&lt;(), std::io::Error&gt; {</span></div><div class="token-line"><span class="token plain" style="display:inline-block">    println!(&quot;Connection from {}&quot;, stream.peer_addr()?);</span></div><div class="token-line"><span class="token plain" style="display:inline-block">    let mut buffer = [0; 128]; // 缓存</span></div><div class="token-line"><span class="token plain" style="display:inline-block">    let mut request_string = String::from(&quot;&quot;);</span></div><div class="token-line"><span class="token plain" style="display:inline-block">    // 循环读取stream中的数据</span></div><div class="token-line"><span class="token plain" style="display:inline-block">    loop {</span></div><div class="token-line"><span class="token plain" style="display:inline-block">        let read_len = stream.read(&amp;mut buffer)?;</span></div><div class="token-line"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line"><span class="token plain" style="display:inline-block">        if read_len == 0 {</span></div><div class="token-line"><span class="token plain" style="display:inline-block">            println!(&quot;{}&quot;, request_string);</span></div><div class="token-line"><span class="token plain" style="display:inline-block">            return Ok(());</span></div><div class="token-line"><span class="token plain" style="display:inline-block">        }</span></div><div class="token-line"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line"><span class="token plain" style="display:inline-block">        // buffer 的长度很重要</span></div><div class="token-line"><span class="token plain" style="display:inline-block">        request_string += &amp;String::from_utf8_lossy(&amp;buffer[..read_len]).to_owned();</span></div><div class="token-line"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line"><span class="token plain" style="display:inline-block">        stream.write(&amp;buffer[..read_len])?;</span></div><div class="token-line"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line"><span class="token plain" style="display:inline-block">        stream.flush()?;</span></div><div class="token-line"><span class="token plain" style="display:inline-block">    }</span></div><div class="token-line"><span class="token plain" style="display:inline-block">}</span></div></pre></div><blockquote class="Blockquote_Blockquote__387dX blockquote-tag"><p class="P_P__2prMq p-tag">cargo run</p></blockquote><blockquote class="Blockquote_Blockquote__387dX blockquote-tag"><p class="P_P__2prMq p-tag">curl http://localhost:8080/index.html?query=str&amp;id=100 -H &quot;Content-Type: application/json&quot; -X POST -d &#x27;{&quot;productId&quot;: 123456, &quot;quantity&quot;: 100}&#x27;</p></blockquote><h2 id="request" class="Heading_H2__2MwMw h2-tag"><a aria-hidden="true" tabindex="-1" href="#request" class="A_A__LqrNw a-tag"><span class="icon icon-link"></span></a>request</h2><div class="Pre_Pre__269fU pre-tag"><pre class="Code_pre__r85Dc pre-tag prism-code language-bash " style="background-color:#2a2734;color:#9a86fd;overflow:scroll;margin-top:20px;margin-bottom:20px;padding:16px"><span class="Code_language__1zO4b">bash</span><div class="token-line"><span class="token plain" style="display:inline-block">GET /index.html?query</span><span class="token operator" style="display:inline-block">=</span><span class="token plain" style="display:inline-block">str</span><span class="token operator" style="display:inline-block">&amp;</span><span class="token assign-left variable" style="display:inline-block">id</span><span class="token operator" style="display:inline-block">=</span><span class="token number" style="display:inline-block">100</span><span class="token plain" style="display:inline-block"> HTTP/1.1  </span><span class="token comment" style="display:inline-block"># 第一行 包括 method, path, http version； 根据` `进行分割</span><span class="token plain" style="display:inline-block"></span></div><div class="token-line"><span class="token plain" style="display:inline-block">Host: localhost:8080   </span><span class="token comment" style="display:inline-block">## start 请求头， 根据`:`进行分割</span><span class="token plain" style="display:inline-block"></span></div><div class="token-line"><span class="token plain" style="display:inline-block">Connection: keep-alive</span></div><div class="token-line"><span class="token plain" style="display:inline-block">Cache-Control: max-age</span><span class="token operator" style="display:inline-block">=</span><span class="token number" style="display:inline-block">0</span><span class="token plain" style="display:inline-block"></span></div><div class="token-line"><span class="token plain" style="display:inline-block">sec-ch-ua: </span><span class="token string" style="display:inline-block">&quot;Google Chrome&quot;</span><span class="token punctuation" style="display:inline-block">;</span><span class="token assign-left variable" style="display:inline-block">v</span><span class="token operator" style="display:inline-block">=</span><span class="token string" style="display:inline-block">&quot;105&quot;</span><span class="token plain" style="display:inline-block">, </span><span class="token string" style="display:inline-block">&quot;Not)A;Brand&quot;</span><span class="token punctuation" style="display:inline-block">;</span><span class="token assign-left variable" style="display:inline-block">v</span><span class="token operator" style="display:inline-block">=</span><span class="token string" style="display:inline-block">&quot;8&quot;</span><span class="token plain" style="display:inline-block">, </span><span class="token string" style="display:inline-block">&quot;Chromium&quot;</span><span class="token punctuation" style="display:inline-block">;</span><span class="token assign-left variable" style="display:inline-block">v</span><span class="token operator" style="display:inline-block">=</span><span class="token string" style="display:inline-block">&quot;105&quot;</span><span class="token plain" style="display:inline-block"></span></div><div class="token-line"><span class="token plain" style="display:inline-block">sec-ch-ua-mobile: ?0</span></div><div class="token-line"><span class="token plain" style="display:inline-block">sec-ch-ua-platform: </span><span class="token string" style="display:inline-block">&quot;macOS&quot;</span><span class="token plain" style="display:inline-block"></span></div><div class="token-line"><span class="token plain" style="display:inline-block">Upgrade-Insecure-Requests: </span><span class="token number" style="display:inline-block">1</span><span class="token plain" style="display:inline-block"></span></div><div class="token-line"><span class="token plain" style="display:inline-block">User-Agent: Mozilla/5.0 </span><span class="token punctuation" style="display:inline-block">(</span><span class="token plain" style="display:inline-block">Macintosh</span><span class="token punctuation" style="display:inline-block">;</span><span class="token plain" style="display:inline-block"> Intel Mac OS X 10_15_7</span><span class="token punctuation" style="display:inline-block">)</span><span class="token plain" style="display:inline-block"> AppleWebKit/537.36 </span><span class="token punctuation" style="display:inline-block">(</span><span class="token plain" style="display:inline-block">KHTML, like Gecko</span><span class="token punctuation" style="display:inline-block">)</span><span class="token plain" style="display:inline-block"> Chrome/105.0.0.0 Safari/537.36</span></div><div class="token-line"><span class="token plain" style="display:inline-block">Accept: text/html,application/xhtml+xml,application/xml</span><span class="token punctuation" style="display:inline-block">;</span><span class="token assign-left variable" style="display:inline-block">q</span><span class="token operator" style="display:inline-block">=</span><span class="token number" style="display:inline-block">0.9</span><span class="token plain" style="display:inline-block">,image/avif,image/webp,image/apng,*/*</span><span class="token punctuation" style="display:inline-block">;</span><span class="token assign-left variable" style="display:inline-block">q</span><span class="token operator" style="display:inline-block">=</span><span class="token number" style="display:inline-block">0.8</span><span class="token plain" style="display:inline-block">,application/signed-exchange</span><span class="token punctuation" style="display:inline-block">;</span><span class="token assign-left variable" style="display:inline-block">v</span><span class="token operator" style="display:inline-block">=</span><span class="token plain" style="display:inline-block">b3</span><span class="token punctuation" style="display:inline-block">;</span><span class="token assign-left variable" style="display:inline-block">q</span><span class="token operator" style="display:inline-block">=</span><span class="token number" style="display:inline-block">0.9</span><span class="token plain" style="display:inline-block"></span></div><div class="token-line"><span class="token plain" style="display:inline-block">Sec-Fetch-Site: none</span></div><div class="token-line"><span class="token plain" style="display:inline-block">Sec-Fetch-Mode: navigate</span></div><div class="token-line"><span class="token plain" style="display:inline-block">Sec-Fetch-User: ?1</span></div><div class="token-line"><span class="token plain" style="display:inline-block">Sec-Fetch-Dest: document</span></div><div class="token-line"><span class="token plain" style="display:inline-block">Accept-Encoding: gzip, deflate, br</span></div><div class="token-line"><span class="token plain" style="display:inline-block">Accept-Language: en-US,en</span><span class="token punctuation" style="display:inline-block">;</span><span class="token assign-left variable" style="display:inline-block">q</span><span class="token operator" style="display:inline-block">=</span><span class="token number" style="display:inline-block">0.9</span><span class="token plain" style="display:inline-block">,zh-CN</span><span class="token punctuation" style="display:inline-block">;</span><span class="token assign-left variable" style="display:inline-block">q</span><span class="token operator" style="display:inline-block">=</span><span class="token number" style="display:inline-block">0.8</span><span class="token plain" style="display:inline-block">,zh</span><span class="token punctuation" style="display:inline-block">;</span><span class="token assign-left variable" style="display:inline-block">q</span><span class="token operator" style="display:inline-block">=</span><span class="token number" style="display:inline-block">0.7</span><span class="token plain" style="display:inline-block"></span></div><div class="token-line"><span class="token plain" style="display:inline-block">Content-Type: application/json </span><span class="token comment" style="display:inline-block">## end</span><span class="token plain" style="display:inline-block"></span></div><div class="token-line"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line"><span class="token plain" style="display:inline-block"></span><span class="token punctuation" style="display:inline-block">{</span><span class="token string" style="display:inline-block">&quot;productId&quot;</span><span class="token builtin class-name" style="display:inline-block">:</span><span class="token plain" style="display:inline-block"> </span><span class="token number" style="display:inline-block">123456</span><span class="token plain" style="display:inline-block">, </span><span class="token string" style="display:inline-block">&quot;quantity&quot;</span><span class="token builtin class-name" style="display:inline-block">:</span><span class="token plain" style="display:inline-block"> </span><span class="token number" style="display:inline-block">100</span><span class="token punctuation" style="display:inline-block">}</span><span class="token plain" style="display:inline-block"> </span><span class="token comment" style="display:inline-block"># 请求数据</span></div></pre></div></article></div></div><footer class="Layout_footer__1xrEh"><span style="margin-right:20px">I&#x27;m here </span><a href="https://github.com/freeshineit" target="_block">ShineShao</a><a href="https://github.com/freeshineit/freeshineit.github.io/issues" target="_blank" style="margin-left:20px">issues</a></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/blog/rust/tcp_stream_read","query":{},"buildId":"lNSYQ5l6Gj-E0aCpr1D3s","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script><script src="/static/js/heading.js"></script></body></html>