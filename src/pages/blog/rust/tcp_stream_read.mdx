import MDXContentCom from "../../../components/MDXContent";

export const meta = {
  title: "Read Rust TcpStream",
  description: "Rust原生读取TcpStream并转成字符串",
  date: "2022-10-12",
  cover: "/static/images/rust.png"
};

export default ({ children }) => (
  <MDXContentCom meta={meta}>{children}</MDXContentCom>
);

## Code

```rust
use std::{
    io::{Read, Write},
    net::{TcpListener, TcpStream},
};

use std::thread;
fn main() {
    let socket = TcpListener::bind("127.0.0.1:8080").unwrap();
    for stream in socket.incoming() {
        match stream {
            Err(e) => {
                eprintln!("error: {}", e)
            }
            Ok(stream) => {
                thread::spawn(move || {
                    handler(stream).unwrap_or_else(|error| eprintln!("{:?}", error));
                });
            }
        }
    }
}

// Starts with being connected from a client
fn handler(mut stream: TcpStream) -> Result<(), std::io::Error> {
    println!("Connection from {}", stream.peer_addr()?);
    let mut buffer = [0; 128]; // 缓存
    let mut request_string = String::from("");
    // 循环读取stream中的数据
    loop {
        let read_len = stream.read(&mut buffer)?;

        if read_len == 0 {
            println!("{}", request_string);
            return Ok(());
        }

        // buffer 的长度很重要
        request_string += &String::from_utf8_lossy(&buffer[..read_len]).to_owned();

        stream.write(&buffer[..read_len])?;

        stream.flush()?;
    }
}
```

> cargo run

> curl http://localhost:8080/index.html?query=str&id=100 -H "Content-Type: application/json" -X POST -d '{"productId": 123456, "quantity": 100}'

## request

```bash
GET /index.html?query=str&id=100 HTTP/1.1  # 第一行 包括 method, path, http version； 根据` `进行分割
Host: localhost:8080   ## start 请求头， 根据`:`进行分割
Connection: keep-alive
Cache-Control: max-age=0
sec-ch-ua: "Google Chrome";v="105", "Not)A;Brand";v="8", "Chromium";v="105"
sec-ch-ua-mobile: ?0
sec-ch-ua-platform: "macOS"
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/105.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Sec-Fetch-Site: none
Sec-Fetch-Mode: navigate
Sec-Fetch-User: ?1
Sec-Fetch-Dest: document
Accept-Encoding: gzip, deflate, br
Accept-Language: en-US,en;q=0.9,zh-CN;q=0.8,zh;q=0.7
Content-Type: application/json ## end

{"productId": 123456, "quantity": 100} # 请求数据
```
